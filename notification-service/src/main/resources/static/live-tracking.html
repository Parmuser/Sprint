<!DOCTYPE html>
<html>
<head>
    <title>Live Delivery Tracking</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .notification { 
            background: white; 
            border-left: 4px solid #007bff; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .delivery-update { 
            background: #e8f5e8; 
            border-left: 4px solid #28a745; 
        }
        .high-priority { 
            background: #ffe8e8; 
            border-left: 4px solid #dc3545; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .status { padding: 10px; background: #007bff; color: white; border-radius: 5px; }
        .connected { background: #28a745; }
        .disconnected { background: #dc3545; }
        input, button { padding: 10px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; }
        .controls { background: white; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .timestamp { color: #666; font-size: 0.8em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöö Live Delivery Tracking</h1>
        
        <div class="controls">
            <h3>Connection</h3>
            <input type="text" id="userId" placeholder="Enter User ID" value="456">
            <input type="text" id="orderId" placeholder="Enter Order ID" value="123">
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
            <button onclick="trackOrder()">Track Order</button>
            <div id="status" class="status disconnected">Disconnected</div>
        </div>

        <div id="notifications">
            <h3>üì± Live Notifications</h3>
            <div id="notificationList"></div>
        </div>

        <div id="deliveryTracking">
            <h3>üöö Delivery Tracking</h3>
            <div id="trackingList"></div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let userId = null;

        function connect() {
            userId = document.getElementById('userId').value;
            if (!userId) {
                alert('Please enter a User ID');
                return;
            }

            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                updateStatus('Connected', true);

                // Subscribe to user-specific notifications
                stompClient.subscribe('/user/queue/notifications', function(notification) {
                    showNotification(JSON.parse(notification.body));
                });

                // Subscribe to delivery tracking updates
                stompClient.subscribe('/user/queue/delivery-tracking', function(update) {
                    showDeliveryUpdate(JSON.parse(update.body));
                });

                // Subscribe to general announcements
                stompClient.subscribe('/topic/announcements', function(announcement) {
                    showAnnouncement(JSON.parse(announcement.body));
                });

                // Send connection message
                stompClient.send("/app/connect", {}, JSON.stringify({
                    'userId': userId
                }));

            }, function(error) {
                console.error('Connection error: ', error);
                updateStatus('Connection Failed', false);
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            updateStatus('Disconnected', false);
            console.log("Disconnected");
        }

        function trackOrder() {
            const orderId = document.getElementById('orderId').value;
            if (stompClient && userId && orderId) {
                stompClient.send("/app/track-order", {}, JSON.stringify({
                    'userId': userId,
                    'orderId': orderId
                }));
                addMessage('trackingList', `Started tracking order #${orderId}`, 'info');
            } else {
                alert('Please connect first and enter an Order ID');
            }
        }

        function showNotification(notification) {
            console.log('Received notification:', notification);
            const priority = notification.priority === 'HIGH' ? 'high-priority' : '';
            const content = `
                <div class="notification ${priority}">
                    <h4>${notification.title}</h4>
                    <p>${notification.message}</p>
                    <div class="timestamp">Order #${notification.orderId} | ${notification.timestamp}</div>
                </div>
            `;
            addToList('notificationList', content);

            // Show browser notification if supported
            if (Notification.permission === 'granted') {
                new Notification(notification.title, {
                    body: notification.message,
                    icon: 'üçï'
                });
            }
        }

        function showDeliveryUpdate(update) {
            console.log('Received delivery update:', update);
            const content = `
                <div class="notification delivery-update">
                    <h4>üìç ${update.eventType.replace('_', ' ')}</h4>
                    <p>${update.message}</p>
                    <p><strong>Estimated Time:</strong> ${update.estimatedTime}</p>
                    <div class="timestamp">Order #${update.orderId} | ${update.timestamp}</div>
                </div>
            `;
            addToList('trackingList', content);

            // Update page title with latest status
            document.title = `${update.eventType} - Order #${update.orderId}`;
        }

        function showAnnouncement(announcement) {
            const content = `
                <div class="notification" style="border-left-color: #ffc107; background: #fff8e1;">
                    <h4>üì¢ ${announcement.title}</h4>
                    <p>${announcement.message}</p>
                    <div class="timestamp">${announcement.timestamp}</div>
                </div>
            `;
            addToList('notificationList', content);
        }

        function addToList(listId, content) {
            const list = document.getElementById(listId);
            list.insertAdjacentHTML('afterbegin', content);
            
            // Keep only last 10 notifications
            while (list.children.length > 10) {
                list.removeChild(list.lastChild);
            }
        }

        function addMessage(listId, message, type) {
            const content = `
                <div class="notification">
                    <p>${message}</p>
                    <div class="timestamp">${new Date().toISOString()}</div>
                </div>
            `;
            addToList(listId, content);
        }

        function updateStatus(message, connected) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = connected ? 'status connected' : 'status disconnected';
        }

        // Request notification permission
        if ('Notification' in window) {
            Notification.requestPermission();
        }

        // Auto-connect on page load (for testing)
        window.addEventListener('load', function() {
            // Uncomment to auto-connect
            // setTimeout(connect, 1000);
        });
    </script>
</body>
</html>
