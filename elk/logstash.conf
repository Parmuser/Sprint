input {
  file {
    path => "/usr/share/logstash/logs/*-json.log"
    codec => "json"
    start_position => "beginning"
    tags => ["microservice", "json"]
  }
  
  file {
    path => "/usr/share/logstash/logs/*.log"
    exclude => "*-json.log"
    start_position => "beginning"
    tags => ["microservice", "text"]
  }

  beats {
    port => 5044
  }
}

filter {
  if "microservice" in [tags] {
    if [path] =~ /user-service/ {
      mutate { add_field => { "service" => "user-service" } }
    } else if [path] =~ /restaurant-service/ {
      mutate { add_field => { "service" => "restaurant-service" } }
    } else if [path] =~ /order-service/ {
      mutate { add_field => { "service" => "order-service" } }
    } else if [path] =~ /notification-service/ {
      mutate { add_field => { "service" => "notification-service" } }
    }
    
    # Parse log levels and timestamps for text logs
    if "text" in [tags] {
      grok {
        match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{DATA:thread}\] %{LOGLEVEL:level} \[%{DATA:logger}\] - %{GREEDYDATA:log_message}" }
      }
      
      date {
        match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
      }
    }
  }
  
  # Add environment information
  mutate {
    add_field => { "environment" => "development" }
    add_field => { "application" => "zomato-microservices" }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "zomato-logs-%{+YYYY.MM.dd}"
  }
  
  stdout {
    codec => rubydebug
  }
}
